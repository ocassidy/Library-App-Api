# Java Gradle CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-java/ for more details
#
version: 2
jobs:
  build:
    docker:
      # Configure the JVM and Gradle to avoid OOM errors
      _JAVA_OPTIONS: "-Xmx3g"
      GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.workers.max=2"
      docker: # run the steps with Docker
        - image: circleci/openjdk:11.0.3-jdk-stretch # ...with this image as the primary container; this is where all `steps` will run
        - image: circleci/postgres:12-alpine

        working_directory: ~/repo

        environment:
          LIBRARY_DB_USERNAME: Library_App_Api_User
          LIBRARY_DB_PASSWORD: finalYearAppProject
          TERM: dumb

          steps:
            - checkout

            # Download and cache dependencies
            - restore_cache:
                key: v1-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - restore_cache:
                key: v1-gradle-cache-{{ checksum "build.gradle" }}
                  # fallback to using the latest cache if no exact match is found
                  - v1-dependencies-

            - run: gradle dependencies

            - save_cache:
                paths:
                  - ~/.gradle/wrapper
                  key: v1-gradle-wrapper-{{ checksum "gradle/wrapper/gradle-wrapper.properties" }}
            - save_cache:
                paths:
                  - ~/.gradle/caches
                  key: v1-gradle-cache-{{ checksum "build.gradle" }}

            - run:
                name: Assemble JAR
                command: |
                  if [ "$CIRCLE_NODE_INDEX" == 0 ]; then
                  ./gradlew assemble
                  fi
            - store_artifacts:
                path: build/libs

            # clean build - runs tests
            - run: gradle clean build

orbs:
  heroku: circleci/heroku@1.0.0
workflows:
  version: 2
  workflow:
    jobs:
      - build
  heroku_deploy:
    jobs:
      - heroku/deploy-via-git